# main.py
import asyncio
import os
from pathlib import Path
from datetime import datetime
from dotenv import load_dotenv
import json

from config import MODEL_CONFIG, OUTPUT_DIR, CREATION_CONFIG
from utils import save_json, save_text
from core.workflow_service import WorkflowService

async def main():
    """ä¸»ç¨‹åº"""
    # åŠ è½½ç¯å¢ƒå˜é‡
    load_dotenv()

    print("\n" + "="*60)
    print("ğŸš€ ç½‘ç»œå°è¯´AIåˆ›ä½œç³»ç»Ÿ")
    print("="*60)

    # æ£€æŸ¥APIå¯†é’¥
    api_key = os.getenv("QWEN_API_KEY")
    if not api_key:
        print("âŒ é”™è¯¯: æœªè®¾ç½® QWEN_API_KEY ç¯å¢ƒå˜é‡")
        return

    # åˆå§‹åŒ–å·¥ä½œæµæœåŠ¡
    print("\nğŸ”§ åˆå§‹åŒ–å·¥ä½œæµæœåŠ¡...")
    workflow_service = WorkflowService()

    try:
        # åˆå§‹åŒ–æ¨¡å‹
        await workflow_service.initialize_models(
            api_key=api_key,
            base_url=MODEL_CONFIG["base_url"],
            model_name=MODEL_CONFIG["model"]
        )
        print("âœ… å·¥ä½œæµæœåŠ¡åˆå§‹åŒ–å®Œæˆ")
    except Exception as e:
        print(f"âŒ å·¥ä½œæµæœåŠ¡åˆå§‹åŒ–å¤±è´¥: {e}")
        return

    # æ˜¾ç¤ºåˆ›ä½œé…ç½® - ç°åœ¨å°†ä½¿ç”¨AIè¿›è¡ŒåŠ¨æ€åˆ†ç« 
    print(f"\nâš™ï¸  åˆ›ä½œé…ç½® (AIåŠ¨æ€å†³å®šåˆ†ç« ):")
    print(f"   åŸé…ç½®ç« æ•° (å·²å–ä»£): {CREATION_CONFIG['num_chapters']}")
    print(f"   æ¯ç« ç›®æ ‡å­—æ•°: {CREATION_CONFIG['target_length_per_chapter']} å­—")
    print(f"   æ€»ç›®æ ‡å­—æ•°: {CREATION_CONFIG['total_target_length']} å­—")
    print(f"   æ³¨æ„: ç« èŠ‚æ•°é‡ç°ç”±AIæ™ºèƒ½å†³å®š")

    # è·å–é»˜è®¤åˆ›æ„è¾“å…¥
    print("\n" + "="*60)
    print("ğŸ“ ä½¿ç”¨é»˜è®¤åˆ›æ„è¿›è¡Œåˆ›ä½œ")
    print("="*60)

    novel_concept = """
    åˆ‘å¤©ä¸å¸è‡³æ­¤äº‰ç¥ï¼Œå¸æ–­å…¶é¦–ï¼Œè‘¬ä¹‹å¸¸ç¾Šä¹‹å±±ã€‚ä¹ƒä»¥ä¹³ä¸ºç›®ï¼Œä»¥è„ä¸ºå£ï¼Œæ“å¹²æˆšä»¥èˆã€‚
    """

    print(f"\nğŸ“– é»˜è®¤åˆ›æ„:")
    print(f"{novel_concept}")

    # æ‰§è¡Œå·¥ä½œæµç¨‹
    try:
        print("\nğŸ”„ å¼€å§‹åˆ›ä½œæµç¨‹...")
        result = await workflow_service.execute_workflow(
            novel_concept=novel_concept,
            multi_chapter=CREATION_CONFIG['num_chapters'] > 1,
            total_chapters=CREATION_CONFIG['num_chapters']
        )

        if result["status"] == "success":
            final_output = result["data"]

            # ä¿å­˜ç»“æœ
            print("\n" + "="*60)
            print("ğŸ’¾ ä¿å­˜ç»“æœ")
            print("="*60)

            OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

            # ä¿å­˜æ•…äº‹æ–‡æœ¬
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            story_file = OUTPUT_DIR / f"novel_story_{timestamp}.txt"
            save_text(final_output["final_story"], story_file)

            # ä¿å­˜å®Œæ•´æ•°æ®
            data_file = OUTPUT_DIR / f"novel_data_{timestamp}.json"
            save_json(final_output, data_file)

            # ä¿å­˜å¯¹è¯å†å²
            history_data = workflow_service.get_conversation_history()
            history_file = OUTPUT_DIR / f"conversation_history_{timestamp}.json"
            save_json(history_data, history_file)

            # æ˜¾ç¤ºæ‘˜è¦
            print("\n" + "="*60)
            print("âœ… åˆ›ä½œå®Œæˆï¼")
            print("="*60)
            print(f"\nğŸ“Š åˆ›ä½œæ‘˜è¦:")
            print(f"  â€¢ åˆå§‹æƒ³æ³•: {final_output['initial_idea'][:50]}...")
            print(f"  â€¢ æ•…äº‹å­—æ•°: {len(final_output['final_story'])} å­—")
            print(f"  â€¢ ç ”ç©¶è®¡åˆ’é•¿åº¦: {len(final_output['research_plan'])} å­—ç¬¦")
            print(f"  â€¢ åˆ›ä½œæ¨¡å¼: {'åˆ†ç« èŠ‚æ¨¡å¼' if CREATION_CONFIG['num_chapters'] > 1 else 'å•ç« æ¨¡å¼'}")

            print(f"\nğŸ“ è¾“å‡ºæ–‡ä»¶:")
            print(f"  â€¢ æ•…äº‹æ–‡æœ¬: {story_file}")
            print(f"  â€¢ å®Œæ•´æ•°æ®: {data_file}")
            print(f"  â€¢ å¯¹è¯å†å²: {history_file}")

    except Exception as e:
        print(f"\nâŒ é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()

    finally:
        # å…³é—­æ¨¡å‹å®¢æˆ·ç«¯
        if hasattr(workflow_service, 'model_client') and workflow_service.model_client:
            await workflow_service.model_client.close()
        print("\nğŸ‘‹ ç¨‹åºç»“æŸ")

if __name__ == "__main__":
    asyncio.run(main())
